# Swap Utility Architecture and UI Specification

The decentralized swap system for the Blazor wallet has been redesigned to ensure maximum security and transparency for internal swap operations between assets on the same blockchain. The SwapUtility class in the Core project remains the unified entry point, but now exposes a series of public methods that follow a complete and protected transactional flow. In addition to the ExecuteSwapAsync method for execution, the methods GetSwapQuoteAsync to obtain an updated quote with details on estimated confirmation times and transaction costs, and ValidateSwapConditionsAsync for pre-operative validation that checks fund sufficiency, token allowances, and network parameters have been introduced. The core of the system is an atomic transaction mechanism that, leveraging features of modern smart contracts like deadlines and price limits, guarantees the operation is executed only under the agreed conditions or is canceled at no cost to the user, thereby preventing asset loss in case of errors or unfavorable market conditions. The entire process is tracked through a clear transactional state (InQuote, Validating, Executing, Completed, Failed) that the user interface can display in real-time. Conversion times are calculated dynamically and presented to the user, distinguishing between on-chain confirmation time and the effective finality time of the swap. Error handling has been extended to include not only technical network errors but also real-time market conditions, with localized messages explaining the specific reasons for a failure to the user, such as an expired quote or insufficient liquidity reserve. All blockchain-specific logic, such as the interaction with Jupiter for Solana, is encapsulated internally within specialized providers, keeping the public API generic and independent of the underlying network.

The public methods exposed by the SwapUtility are as follows. The GetSwapQuoteAsync method takes a SwapRequest and returns a SwapQuote containing the exchange rate, the minimum amount receivable, the estimated fees, the estimated confirmation time, and a temporal identifier for the quote. The ValidateSwapConditionsAsync method takes a SwapRequest and a SwapQuote to validate the current conditions against the quotation, returning a ValidationResult that includes specific outcomes on fund sufficiency and network status. The ExecuteSwapAsync method now requires both the SwapRequest and the SwapQuote to ensure the operation is executed exactly under the pre-quoted conditions, returning a SwapResult enriched with detailed transactional status and the eventual transaction hash. Finally, the GetSwapStatusAsync method allows for monitoring the status of an ongoing transaction via a transaction identifier.

## UI specification

The user interface for the swap panel in Blazor must meticulously follow Bootstrap's guidelines and utility classes. The main layout uses a grid system with side-by-side Bootstrap cards. The left card, dedicated to swap configuration, presents a Bootstrap form group for the "From" field with a clear structure. The numeric input field for the amount is of type form-control and must display exclusively the numerical value in the unit of the selected currency, for example "100" to indicate 100 EURC, without the currency symbol inside the text field. Next to the input field, the dropdown for selecting the source currency shows the symbol or code of the currency itself. Below this input group, a small line of text with the text-muted and small classes explicitly shows the user's current availability for that specific currency, formatted as "Available: [Value] [Currency Code]", for example "Available: 200 EURC". Immediately below, a range input element of type slider, styled with Bootstrap classes, allows for selecting a percentage from 0 to 100. The fundamental behavior of the percentage slider is to calculate the absolute amount corresponding to the selected percentage of the total currency balance in the wallet and set this value in the amount input field. For instance, if the availability is 200 EURC and the user moves the slider to 5%, the amount field must be automatically updated to the value 10. A Bootstrap badge placed next to the slider dynamically shows the selected percentage as a numerical value followed by the "%" symbol. The right card, for the receipt, hosts a form group for the "To" field with a text muted and read-only input group for the estimated amount in the destination currency. Between the two cards, in a central and prominent position, the exchange rate is displayed in a light Bootstrap alert. The exchange rate data must be exposed in both directions. The first line shows the direct rate with the format "1 [Source Currency] = [Value] [Destination Currency]", for example "1 BTC = 100,000 EURC". Beneath it, a second line with smaller and text-muted font shows the inverse rate with the format "1 [Destination Currency] = [Value] [Source Currency]", for example "1 EURC = 0.00001 BTC". The main "Confirm Swap" action button uses the btn btn-primary classes and its state variants. The recent conversions section is implemented as a scrollable Bootstrap list group, where each item shows the transaction details and its status through the use of contextual badges. The interface is designed to be intrinsically responsive and provide immediate visual feedback consistent with user expectations, updating the destination amount and exchange rates in real time as inputs change.

Requirements:

- The currency selector must display the abbreviation, e.g., BTC, EURC
- The UI must display the current exchange rate for the selected cirrency pairs, both direct and inverse (e.g., 1 BTC = 70.0000 EURC). The exchange rate must update every minute and be relevant to the system that will perform the conversion in the backend.

## Note about relative fIle positions:

\ClickPay\ClickPay.Wallet.Core\Utility\SwapUtility.cs (the utility in the core project)
\ClickPay\ClickPay.Shared\Pages\Convert.razor (User interface)

