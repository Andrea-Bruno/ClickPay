@using System
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using ClickPay.Wallet.Core.CryptoAssets
@using ClickPay.Wallet.Core.Wallet
@using ClickPay.Shared.Services
@inject LocalizationService Loc
@inject NavigationManager Navigation
@inject ILocalSecureStore SecureStore
@implements IDisposable
<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">ClickPay</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="pay">
                <svg class="nav-icon" viewBox="002424" aria-hidden="true">
                <rect x="3.5" y="3.5" width="6.5" height="6.5" fill="none" stroke="currentColor" stroke-width="1.5" rx="1" />
                <rect x="14" y="3.5" width="6.5" height="6.5" fill="none" stroke="currentColor" stroke-width="1.5" rx="1" />
                <rect x="3.5" y="14" width="6.5" height="6.5" fill="none" stroke="currentColor" stroke-width="1.5" rx="1" />
                <rect x="11.5" y="11.5" width="3.2" height="3.2" fill="currentColor" rx="0.5" />
                <rect x="17" y="17" width="3.2" height="3.2" fill="currentColor" rx="0.5" />
                </svg>
                @Loc.T("NavMenu_Pay")
            </NavLink>
        </div>
        
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="request-payment">
                <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5" />
                    <text x="12" y="16" text-anchor="middle" font-size="10" fill="currentColor">€</text>
                </svg>
                @Loc.T("RequestPayment_Title")
            </NavLink>
        </div>

        @foreach (var asset in WalletAssetHelper.GetVisibleAssets())
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="@GetWalletRoute(asset)">
                    @RenderAssetIcon(asset)
                    <span class="nav-link-text">@GetMenuLabel(asset)</span>
                </NavLink>
            </div>
        }
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="convert">
                <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M16.65 15.65a5 5 0 1 1 0-7.07" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <polyline points="15 14 16.65 15.65 18.3 14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7.35 8.35a5 5 0 1 1 0 7.07" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    <polyline points="9 10 7.35 8.35 5.7 10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                @Loc.T("NavMenu_Convert")
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="setup">
                <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <rect x="3.5" y="5" width="17" height="14" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.4" />
                    <line x1="8" y1="8" x2="8" y2="16" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
                    <circle cx="8" cy="12" r="1.4" fill="currentColor" />
                    <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
                    <circle cx="12" cy="9.5" r="1.4" fill="currentColor" />
                    <line x1="16" y1="8" x2="16" y2="16" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
                    <circle cx="16" cy="14.5" r="1.4" fill="currentColor" />
                </svg>
                @Loc.T("NavMenu_Setup")
            </NavLink>
        </div>
    </nav>
</div>

@code {
    private bool _hasWallet;

    protected override async Task OnInitializedAsync()
    {
        _hasWallet = await WalletKeyUtility.HasVaultAsync(SecureStore);
        Loc.LanguageChanged += OnLanguageChanged;
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    private string GetMenuLabel(CryptoAsset asset)
    {
        var baseLabel = string.Equals(asset.Code, "XAUT", StringComparison.OrdinalIgnoreCase)
            ? Loc.T("GoldWalletMenuLabel")
            : asset.MenuLabel;

        return Loc.FormatWalletLabel(baseLabel);
    }

    private void OnLanguageChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private RenderFragment RenderAssetIcon(CryptoAsset definition) => builder =>
    {
        if (CryptoAssetIconResolver.TryGetIconDataUri(definition, out var source))
        {
            builder.OpenElement(0, "span");
            builder.AddAttribute(1, "class", "nav-icon nav-icon-image");

            builder.OpenElement(2, "img");
            builder.AddAttribute(3, "class", "nav-icon-image-content");
            builder.AddAttribute(4, "src", source);
            builder.AddAttribute(5, "alt", definition.Code);
            builder.AddAttribute(6, "width", "36");
            builder.AddAttribute(7, "height", "36");
            builder.AddAttribute(8, "loading", "lazy");
            builder.CloseElement();

            builder.CloseElement();
            return;
        }

        builder.OpenElement(5, "span");
        builder.AddAttribute(6, "class", GetGlyphCssClass(definition));
        builder.AddContent(7, ResolveIconContent(definition));
        builder.CloseElement();
    };

    private static string ResolveIconContent(CryptoAsset definition)
    {
        if (!string.IsNullOrWhiteSpace(definition.Symbol))
        {
            return definition.Symbol;
        }

        return string.IsNullOrWhiteSpace(definition.Code) ? "#" : definition.Code;
    }

    private static string GetGlyphCssClass(CryptoAsset definition)
    {
        if (!string.IsNullOrWhiteSpace(definition.Symbol))
        {
            return "nav-icon nav-icon-glyph nav-icon-symbol";
        }

        return "nav-icon nav-icon-glyph nav-icon-code";
    }

    private static string GetWalletRoute(CryptoAsset asset) => $"/wallet/{WalletAssetHelper.GetRouteSegment(asset)}";

    public void Dispose()
    {
        Loc.LanguageChanged -= OnLanguageChanged;
    }

#if DEBUG
    private bool _resetting;

    private string resetText => _resetting ? Loc.T("NavMenu_ResettingWallet") : Loc.T("NavMenu_ResetWalletDebug");

    private async Task ResetWalletAsync()
    {
        if (_resetting)
        {
            return;
        }

        _resetting = true;

        try
        {
            await WalletKeyUtility.RemoveVaultAsync(SecureStore);
            await SecureStore.DeleteAsync("DisclaimerAccepted");
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Wallet reset failed: {ex.Message}");
        }
        finally
        {
            _resetting = false;
            await InvokeAsync(StateHasChanged);
        }
    }
#endif
}

