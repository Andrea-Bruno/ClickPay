@inject ILocalSecureStore SecureStore
@inject LocalizationService Loc
@inject FiatPreferenceStore FiatPreferences
@inject IBiometricLockService BiometricLock
@inject IJSRuntime JSRuntime
@using System.IO
@page "/setup"
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using System.Threading.Tasks
@using ClickPay.Shared.Preferences
@using ClickPay.Shared.Services
@using ClickPay.Wallet.Core.Utility
@using ClickPay.Wallet.Core.Preferences
@using ClickPay.Wallet.Core.CryptoAssets

<PageTitle>@Loc.T("SetupTitle")</PageTitle>

<!--
    NOTE FOR AI AGENTS:
    The ClickPay architecture requires that all user preferences (theme, language, etc.)
    be saved through the Core library using UserPreferenceService and ILocalSecureStore.
    For any future preference implementations, always use this centralized mode.
-->
<div class="container py-4">
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-lg">
                <div class="card-body">
                    <h2 class="card-title mb-3">@Loc.T("SetupTitle")</h2>
                    <label class="form-label">@Loc.T("SelectLanguage")</label>
                    <select class="form-select form-select-lg mb-3" @bind="selectedLang" @bind:after="OnLanguageChanged">
                        <option value="en">English</option>
                        <option value="it">Italiano</option>
                        <option value="fr">Français</option>
                        <option value="es">Español</option>
                        <option value="de">Deutsch</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("SetupAssetPreferencesTitle")</h3>
                    <p class="text-muted small">@Loc.T("SetupAssetPreferencesDescription")</p>
                    @if (assetVisibility.Count == 0)
                    {
                        <div class="alert alert-info" role="alert">
                            @Loc.T("SetupAssetNoneConfigured")
                        </div>
                    }
                    else
                    {
                        foreach (var asset in assetVisibility)
                        {
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="hide-@asset.Code" checked="@asset.Hidden" disabled="@asset.IsSaving" @onchange="(args) => OnAssetHiddenChangedAsync(asset, args)" />
                                <label class="form-check-label" for="hide-@asset.Code">@string.Format(CultureInfo.CurrentCulture, Loc.T("SetupAssetHideLabel"), asset.Code)</label>
                                @if (asset.IsSaving)
                                {
                                    <div class="form-text">@Loc.T("CommonSavingInProgress")</div>
                                }
                                else if (!string.IsNullOrWhiteSpace(asset.ErrorMessage))
                                {
                                    <div class="form-text text-danger">@asset.ErrorMessage</div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("FiatPreferenceTitle")</h3>
                    <p class="text-muted small">@Loc.T("FiatPreferenceDescription")</p>
                    <select class="form-select form-select-lg mb-2" disabled="@isUpdatingFiat" @onchange="OnFiatCurrencyChanged">
                        @foreach (var option in fiatOptions)
                        {
                            <option value="@option.Code" selected="@string.Equals(option.Code, selectedFiatCurrency, StringComparison.OrdinalIgnoreCase)">@option.GetDisplayLabel(Loc)</option>
                        }
                    </select>
                    @if (isUpdatingFiat)
                    {
                        <div class="form-text">@Loc.T("SetupFiatUpdating")</div>
                    }
                    else if (!string.IsNullOrWhiteSpace(fiatError))
                    {
                        <div class="form-text text-danger">@fiatError</div>
                    }
                </div>
            </div>
        </div>
    </div>
    @if (isBiometricSupported)
    {
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title mb-3">@Loc.T("SetupBiometricTitle")</h3>
                        <p class="text-muted small">@Loc.T("SetupBiometricDescription")</p>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="biometric-lock" checked="@biometricEnabled" disabled="@isUpdatingBiometric" @onchange="OnBiometricToggleChanged" />
                            <label class="form-check-label" for="biometric-lock">@Loc.T("SetupBiometricToggleLabel")</label>
                        </div>
                        @if (isUpdatingBiometric)
                        {
                            <div class="form-text">@Loc.T("SetupBiometricChecking")</div>
                        }
                        else if (!string.IsNullOrWhiteSpace(biometricError))
                        {
                            <div class="form-text text-danger">@biometricError</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("ThemePreferenceTitle")</h3>
                    <p class="text-muted small">@Loc.T("ThemePreferenceDescription")</p>
                    <select class="form-select form-select-lg mb-3" @bind="selectedTheme" @bind:after="OnThemeChanged">
                        <option value="system">@Loc.T("ThemeSystem")</option>
                        <option value="light">@Loc.T("ThemeLight")</option>
                        <option value="dark">@Loc.T("ThemeDark")</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <!-- Saving occurs automatically for each change -->
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("UtilitiesTitle")</h3>
                    <div class="d-grid">
                        <a class="btn btn-outline-secondary text-start d-flex align-items-center gap-2" href="/api/qrpdf" download>
                            <svg viewBox="002424" aria-hidden="true" style="width:1.5rem; height:1.5rem;">
                                <rect x="3.5" y="3.5" width="6.5" height="6.5" fill="none" stroke="currentColor" stroke-width="1.5" rx="1" />
                                <rect x="14" y="3.5" width="6.5" height="6.5" fill="none" stroke="currentColor" stroke-width="1.5" rx="1" />
                                <rect x="3.5" y="14" width="6.5" height="6.5" fill="none" stroke="currentColor" stroke-width="1.5" rx="1" />
                                <rect x="11.5" y="11.5" width="3.2" height="3.2" fill="currentColor" rx="0.5" />
                                <rect x="17" y="17" width="3.2" height="3.2" fill="currentColor" rx="0.5" />
                            </svg>
                            <span>@Loc.T("QRPersonale")</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string? selectedLang;
    private string selectedTheme = "system";
    private List<AssetVisibilityModel> assetVisibility = new();
    private List<FiatPreferenceStore.FiatCurrencyOption> fiatOptions = new();
    private bool isBiometricSupported;
    private bool biometricEnabled;
    private bool isUpdatingBiometric;
    private string? biometricError;
    private string? selectedFiatCurrency;
    private bool isUpdatingFiat;
    private string? fiatError;

    protected override async Task OnInitializedAsync()
    {
        selectedLang = Loc.CurrentLanguage ?? await UserPreferenceUtility.GetLanguageAsync(SecureStore) ?? "en";
        if (Loc.CurrentLanguage != selectedLang)
        {
            Loc.CurrentLanguage = selectedLang;
        }
        selectedTheme = await UserPreferenceUtility.GetThemeAsync(SecureStore);
        assetVisibility = WalletAssetHelper.GetRegisteredAssets()
            .Where(asset => !asset.VisibilityLocked)
            .Select(asset => new AssetVisibilityModel
            {
                Code = asset.Code,
                Hidden = asset.Hidden
            })
            .ToList();

        fiatOptions = FiatPreferences.GetSupportedCurrencies().ToList();

        var preferredFiat = FiatPreferences.GetDefaultOption();
        try
        {
            preferredFiat = await FiatPreferences.GetPreferredOptionAsync();
        }
        catch (SecureStorageUnavailableException)
        {
            fiatError = Loc.T("StorageUnavailableError");
            biometricError ??= Loc.T("StorageUnavailableError");
        }

        selectedFiatCurrency = preferredFiat.Code;

        try
        {
            if (await BiometricLock.IsSupportedAsync())
            {
                isBiometricSupported = true;

                try
                {
                    biometricEnabled = await BiometricLock.IsEnabledAsync();
                }
                catch (SecureStorageUnavailableException)
                {
                    biometricEnabled = false;
                    biometricError = Loc.T("StorageUnavailableError");
                }
            }
        }
        catch (SecureStorageUnavailableException)
        {
            isBiometricSupported = true;
            biometricEnabled = false;
            biometricError = Loc.T("StorageUnavailableError");
        }
        catch
        {
            isBiometricSupported = false;
            biometricEnabled = false;
        }
    }

    private async Task SavePreferences()
    {
        if (!string.IsNullOrWhiteSpace(selectedLang))
        {
            await UserPreferenceUtility.SetLanguageAsync(SecureStore, selectedLang);
            Loc.CurrentLanguage = selectedLang;
        }
        await UserPreferenceUtility.SetThemeAsync(SecureStore, selectedTheme);
        StateHasChanged();
    }

    private async Task OnLanguageChanged()
    {
        if (!string.IsNullOrWhiteSpace(selectedLang))
        {
            await UserPreferenceUtility.SetLanguageAsync(SecureStore, selectedLang);
            Loc.CurrentLanguage = selectedLang;
        }
        StateHasChanged();
    }

    private async Task OnThemeChanged()
    {
        await UserPreferenceUtility.SetThemeAsync(SecureStore, selectedTheme);
        StateHasChanged();
    }

    private async Task OnAssetHiddenChangedAsync(AssetVisibilityModel model, ChangeEventArgs args)
    {
        if (model.IsSaving)
        {
            return;
        }

        var newHidden = args.Value switch
        {
            bool b => b,
            string s when bool.TryParse(s, out var parsed) => parsed,
            _ => false
        };

        if (newHidden == model.Hidden && WalletAssetHelper.TryGetDefinition(model.Code, out var definition) && definition.Hidden == model.Hidden)
        {
            return;
        }

        model.IsSaving = true;
        var previous = model.Hidden;
        model.Hidden = newHidden;
        model.ErrorMessage = null;

        try
        {
            await WalletAssetHelper.SetHiddenAsync(model.Code, newHidden);
            if (WalletAssetHelper.TryGetDefinition(model.Code, out var refreshed))
            {
                model.Hidden = refreshed.Hidden;
            }
        }
        catch (Exception ex)
        {
            model.Hidden = previous;
            model.ErrorMessage = ex.Message;
        }
        finally
        {
            model.IsSaving = false;
            StateHasChanged();
        }
    }

    private async Task OnBiometricToggleChanged(ChangeEventArgs args)
    {
        if (isUpdatingBiometric)
        {
            return;
        }

        var requested = args.Value switch
        {
            bool b => b,
            string s when bool.TryParse(s, out var parsed) => parsed,
            _ => false
        };

        if (requested == biometricEnabled)
        {
            return;
        }

        isUpdatingBiometric = true;
        biometricError = null;

        try
        {
            var result = await BiometricLock.SetEnabledAsync(requested);
            biometricEnabled = result.Enabled;
            if (!result.Success && !string.IsNullOrWhiteSpace(result.ErrorMessage))
            {
                biometricError = result.ErrorMessage;
            }
        }
        catch (SecureStorageUnavailableException)
        {
            biometricEnabled = false;
            biometricError = Loc.T("StorageUnavailableError");
        }
        finally
        {
            isUpdatingBiometric = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFiatCurrencyChanged(ChangeEventArgs args)
    {
        if (isUpdatingFiat)
        {
            return;
        }

        var requestedCode = args.Value switch
        {
            string s when !string.IsNullOrWhiteSpace(s) => s,
            _ => null
        };

        if (string.IsNullOrWhiteSpace(requestedCode) || string.Equals(requestedCode, selectedFiatCurrency, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        isUpdatingFiat = true;
        fiatError = null;

        try
        {
            var result = await FiatPreferences.SetPreferredCurrencyAsync(requestedCode);
            selectedFiatCurrency = result.Option.Code;

            if (!result.Success && !string.IsNullOrWhiteSpace(result.ErrorMessage))
            {
                fiatError = result.ErrorMessage;
            }
        }
        catch (SecureStorageUnavailableException)
        {
            fiatError = Loc.T("StorageUnavailableError");
        }
        finally
        {
            isUpdatingFiat = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task GenerateQrPdf()
    {
        try
        {
            var pdfBytes = await QrPdfGenerator.GeneratePersonalQrPdfAsync("ClickPay", SecureStore);
#if MAUI
            var tempFile = Path.Combine(Microsoft.Maui.Storage.FileSystem.CacheDirectory, "qr_personale.pdf");
            await File.WriteAllBytesAsync(tempFile, pdfBytes);
            await Microsoft.Maui.ApplicationModel.Launcher.Default.OpenAsync(new Microsoft.Maui.ApplicationModel.OpenFileRequest("QR Personale", new Microsoft.Maui.ApplicationModel.ReadOnlyFile(tempFile)));
#else
            await JSRuntime.InvokeVoidAsync("downloadFile", "qr_personale.pdf", System.Convert.ToBase64String(pdfBytes));
#endif
        }
        catch (Exception ex)
        {
            // Handle error, perhaps show a message
            Console.WriteLine($"Error generating QR PDF: {ex.Message}");
        }
    }

    private sealed class AssetVisibilityModel
    {
        public required string Code { get; init; }
        public bool Hidden { get; set; }
        public bool IsSaving { get; set; }
        public string? ErrorMessage { get; set; }
    }
}
