@inject ILocalSecureStore SecureStore
@page "/setup"
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using System.Threading.Tasks
@using ClickPay.Shared.Preferences
@using ClickPay.Shared.Services
@using ClickPay.Wallet.Core.Utility
@using ClickPay.Wallet.Core.Preferences
@using ClickPay.Wallet.Core.CryptoAssets
@inject LocalizationService Loc
@inject FiatPreferenceStore FiatPreferences
@inject IBiometricLockService BiometricLock

<PageTitle>@Loc.T("SetupTitle")</PageTitle>

<!--
    NOTA PER AGENTI AI:
    L'architettura di ClickPay prevede che tutte le preferenze utente (tema, lingua, ecc.)
    siano salvate tramite la libreria Core usando UserPreferenceService e ILocalSecureStore.
    Per ogni futura implementazione di preferenze, utilizzare sempre questa modalità centralizzata.
-->
<div class="container py-4">
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-lg">
                <div class="card-body">
                    <h2 class="card-title mb-3">@Loc.T("SetupTitle")</h2>
                    <label class="form-label">@Loc.T("SelectLanguage")</label>
                    <select class="form-select form-select-lg mb-3" @bind="selectedLang">
                        <option value="en">English</option>
                        <option value="it">Italiano</option>
                        <option value="fr">Français</option>
                        <option value="es">Español</option>
                        <option value="de">Deutsch</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("SetupAssetPreferencesTitle")</h3>
                    <p class="text-muted small">@Loc.T("SetupAssetPreferencesDescription")</p>
                    @if (assetVisibility.Count == 0)
                    {
                        <div class="alert alert-info" role="alert">
                            @Loc.T("SetupAssetNoneConfigured")
                        </div>
                    }
                    else
                    {
                        foreach (var asset in assetVisibility)
                        {
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="hide-@asset.Code" checked="@asset.Hidden" disabled="@asset.IsSaving" @onchange="(args) => OnAssetHiddenChangedAsync(asset, args)" />
                                <label class="form-check-label" for="hide-@asset.Code">@string.Format(CultureInfo.CurrentCulture, Loc.T("SetupAssetHideLabel"), asset.Code)</label>
                                @if (asset.IsSaving)
                                {
                                    <div class="form-text">@Loc.T("CommonSavingInProgress")</div>
                                }
                                else if (!string.IsNullOrWhiteSpace(asset.ErrorMessage))
                                {
                                    <div class="form-text text-danger">@asset.ErrorMessage</div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("FiatPreferenceTitle")</h3>
                    <p class="text-muted small">@Loc.T("FiatPreferenceDescription")</p>
                    <select class="form-select form-select-lg mb-2" disabled="@isUpdatingFiat" @onchange="OnFiatCurrencyChanged">
                        @foreach (var option in fiatOptions)
                        {
                            <option value="@option.Code" selected="@string.Equals(option.Code, selectedFiatCurrency, StringComparison.OrdinalIgnoreCase)">@option.GetDisplayLabel(Loc)</option>
                        }
                    </select>
                    @if (isUpdatingFiat)
                    {
                        <div class="form-text">@Loc.T("SetupFiatUpdating")</div>
                    }
                    else if (!string.IsNullOrWhiteSpace(fiatError))
                    {
                        <div class="form-text text-danger">@fiatError</div>
                    }
                </div>
            </div>
        </div>
    </div>
    @if (isBiometricSupported)
    {
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title mb-3">@Loc.T("SetupBiometricTitle")</h3>
                        <p class="text-muted small">@Loc.T("SetupBiometricDescription")</p>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="biometric-lock" checked="@biometricEnabled" disabled="@isUpdatingBiometric" @onchange="OnBiometricToggleChanged" />
                            <label class="form-check-label" for="biometric-lock">@Loc.T("SetupBiometricToggleLabel")</label>
                        </div>
                        @if (isUpdatingBiometric)
                        {
                            <div class="form-text">@Loc.T("SetupBiometricChecking")</div>
                        }
                        else if (!string.IsNullOrWhiteSpace(biometricError))
                        {
                            <div class="form-text text-danger">@biometricError</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">@Loc.T("ThemePreferenceTitle")</h3>
                    <p class="text-muted small">@Loc.T("ThemePreferenceDescription")</p>
                    <select class="form-select form-select-lg mb-3" @bind="selectedTheme">
                        <option value="system">@Loc.T("ThemeSystem")</option>
                        <option value="light">@Loc.T("ThemeLight")</option>
                        <option value="dark">@Loc.T("ThemeDark")</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8 d-grid">
            <button class="btn btn-success btn-lg w-100" @onclick="SavePreferences">@Loc.T("Save")</button>
        </div>
    </div>
</div>

@code {
    private string? selectedLang;
    private string selectedTheme = "system";
    private List<AssetVisibilityModel> assetVisibility = new();
    private List<FiatPreferenceStore.FiatCurrencyOption> fiatOptions = new();
    private bool isBiometricSupported;
    private bool biometricEnabled;
    private bool isUpdatingBiometric;
    private string? biometricError;
    private string? selectedFiatCurrency;
    private bool isUpdatingFiat;
    private string? fiatError;

    protected override async Task OnInitializedAsync()
    {
        selectedLang = await UserPreferenceUtility.GetLanguageAsync(SecureStore);
        selectedTheme = await UserPreferenceUtility.GetThemeAsync(SecureStore);
        assetVisibility = WalletAssetHelper.GetRegisteredAssets()
            .Where(asset => !asset.VisibilityLocked)
            .Select(asset => new AssetVisibilityModel
            {
                Code = asset.Code,
                Hidden = asset.Hidden
            })
            .ToList();

        fiatOptions = FiatPreferences.GetSupportedCurrencies().ToList();

        var preferredFiat = FiatPreferences.GetDefaultOption();
        try
        {
            preferredFiat = await FiatPreferences.GetPreferredOptionAsync();
        }
        catch (SecureStorageUnavailableException)
        {
            fiatError = Loc.T("StorageUnavailableError");
            biometricError ??= Loc.T("StorageUnavailableError");
        }

        selectedFiatCurrency = preferredFiat.Code;

        try
        {
            if (await BiometricLock.IsSupportedAsync())
            {
                isBiometricSupported = true;

                try
                {
                    biometricEnabled = await BiometricLock.IsEnabledAsync();
                }
                catch (SecureStorageUnavailableException)
                {
                    biometricEnabled = false;
                    biometricError = Loc.T("StorageUnavailableError");
                }
            }
        }
        catch (SecureStorageUnavailableException)
        {
            isBiometricSupported = true;
            biometricEnabled = false;
            biometricError = Loc.T("StorageUnavailableError");
        }
        catch
        {
            isBiometricSupported = false;
            biometricEnabled = false;
        }
    }

    private async Task SavePreferences()
    {
        if (!string.IsNullOrWhiteSpace(selectedLang))
        {
            await UserPreferenceUtility.SetLanguageAsync(SecureStore, selectedLang);
            Loc.CurrentLanguage = selectedLang;
        }
        await UserPreferenceUtility.SetThemeAsync(SecureStore, selectedTheme);
        StateHasChanged();
    }

    private async Task OnAssetHiddenChangedAsync(AssetVisibilityModel model, ChangeEventArgs args)
    {
        if (model.IsSaving)
        {
            return;
        }

        var newHidden = args.Value switch
        {
            bool b => b,
            string s when bool.TryParse(s, out var parsed) => parsed,
            _ => false
        };

        if (newHidden == model.Hidden && WalletAssetHelper.TryGetDefinition(model.Code, out var definition) && definition.Hidden == model.Hidden)
        {
            return;
        }

        model.IsSaving = true;
        var previous = model.Hidden;
        model.Hidden = newHidden;
        model.ErrorMessage = null;

        try
        {
            await WalletAssetHelper.SetHiddenAsync(model.Code, newHidden);
            if (WalletAssetHelper.TryGetDefinition(model.Code, out var refreshed))
            {
                model.Hidden = refreshed.Hidden;
            }
        }
        catch (Exception ex)
        {
            model.Hidden = previous;
            model.ErrorMessage = ex.Message;
        }
        finally
        {
            model.IsSaving = false;
            StateHasChanged();
        }
    }

    private async Task OnBiometricToggleChanged(ChangeEventArgs args)
    {
        if (isUpdatingBiometric)
        {
            return;
        }

        var requested = args.Value switch
        {
            bool b => b,
            string s when bool.TryParse(s, out var parsed) => parsed,
            _ => false
        };

        if (requested == biometricEnabled)
        {
            return;
        }

        isUpdatingBiometric = true;
        biometricError = null;

        try
        {
            var result = await BiometricLock.SetEnabledAsync(requested);
            biometricEnabled = result.Enabled;
            if (!result.Success && !string.IsNullOrWhiteSpace(result.ErrorMessage))
            {
                biometricError = result.ErrorMessage;
            }
        }
        catch (SecureStorageUnavailableException)
        {
            biometricEnabled = false;
            biometricError = Loc.T("StorageUnavailableError");
        }
        finally
        {
            isUpdatingBiometric = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFiatCurrencyChanged(ChangeEventArgs args)
    {
        if (isUpdatingFiat)
        {
            return;
        }

        var requestedCode = args.Value switch
        {
            string s when !string.IsNullOrWhiteSpace(s) => s,
            _ => null
        };

        if (string.IsNullOrWhiteSpace(requestedCode) || string.Equals(requestedCode, selectedFiatCurrency, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        isUpdatingFiat = true;
        fiatError = null;

        try
        {
            var result = await FiatPreferences.SetPreferredCurrencyAsync(requestedCode);
            selectedFiatCurrency = result.Option.Code;

            if (!result.Success && !string.IsNullOrWhiteSpace(result.ErrorMessage))
            {
                fiatError = result.ErrorMessage;
            }
        }
        catch (SecureStorageUnavailableException)
        {
            fiatError = Loc.T("StorageUnavailableError");
        }
        finally
        {
            isUpdatingFiat = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private sealed class AssetVisibilityModel
    {
        public required string Code { get; init; }
        public bool Hidden { get; set; }
        public bool IsSaving { get; set; }
        public string? ErrorMessage { get; set; }
    }
}
