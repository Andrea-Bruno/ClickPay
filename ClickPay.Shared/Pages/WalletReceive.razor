@page "/wallet/{type}/receive"
@using System.Collections.Generic
@using Microsoft.JSInterop
@using ClickPay.Shared.Services
@using ClickPay.Shared.CryptoAssets
@inject IJSRuntime JS
@inject LocalizationService Loc
@inject MultiChainWalletService Wallets
@inject WalletKeyService Vaults
@inject NavigationManager Navigation

<PageTitle>@Loc.T("ReceivePaymentTitle")</PageTitle>

@if (loading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger" role="alert">@error</div>
}
else if (info is not null)
{
    <h2>
        @if (assetDefinition is not null)
        {
            @GetFormattedAssetLabel(assetDefinition)
        }
        else
        {
            @Loc.T("ReceivePaymentTitle")
        }
        <span class="text-muted ms-2">(@info.Symbol)</span>
    </h2>
    <div class="mb-3">
        <label class="form-label">@Loc.T("Address")</label>
        <input class="form-control" value="@info.Address" readonly />
    </div>
    <div class="mb-3">
        <label class="form-label">@Loc.T("Amount")</label>
        <input class="form-control" type="number" min="0" step="any" @bind="amount" @bind:event="oninput" @bind:after="OnAmountChanged" />
    </div>

    @if (!string.IsNullOrEmpty(paymentUri))
    {
        <div class="text-center my-4">
            <div class="qr-wrapper d-inline-block p-3 bg-white border rounded shadow-sm">
                @qrCodeMarkup
            </div>
            <p class="mt-3 text-muted small">@Loc.T("QRCode")</p>
            <p class="text-break small">@paymentUri</p>
        </div>
    }

    <button class="btn btn-outline-secondary" @onclick="ShareRequest">@Loc.T("ShareRequest")</button>
}

@code {
    [Parameter] public string? type { get; set; }
    private WalletAsset asset;
    private WalletReceiveInfo? info;
    private CryptoAsset? assetDefinition;
    private decimal amount;
    private string? paymentUri;
    private MarkupString qrCodeMarkup;
    private bool loading = true;
    private string? error;
    private bool awaitingInteractive;

    protected override async Task OnInitializedAsync()
    {
        if (!WalletAssetHelper.TryParse(type, out asset))
        {
            error = "Asset non supportato.";
            loading = false;
            return;
        }

        try
        {
            assetDefinition = WalletAssetHelper.GetDefinition(asset);
        }
        catch (Exception ex)
        {
            error = ex.Message;
            loading = false;
            return;
        }

        await InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!awaitingInteractive || firstRender)
        {
            return;
        }

        awaitingInteractive = false;
        await InitializeAsync();

        if (!awaitingInteractive)
        {
            StateHasChanged();
        }
    }

    private async Task InitializeAsync()
    {
        try
        {
            if (!await Vaults.HasVaultAsync())
            {
                Navigation.NavigateTo("/onboarding", true);
                return;
            }

            info = await Wallets.GetReceiveInfoAsync(asset);
            loading = false;
            UpdatePaymentRequest();
        }
        catch (BrowserStorageUnavailableException)
        {
            awaitingInteractive = true;
        }
        catch (Exception ex)
        {
            error = ex.Message;
            loading = false;
        }
    }

    private void UpdatePaymentRequest()
    {
        if (info is null)
        {
            paymentUri = null;
            qrCodeMarkup = default;
            return;
        }

        var mint = info.Metadata is not null && info.Metadata.TryGetValue("mint", out var mintValue) ? mintValue : null;

        paymentUri = asset switch
        {
            WalletAsset.Bitcoin => BuildBitcoinPaymentUri(info.Address, amount),
            WalletAsset.Sol => BuildSolanaPaymentUri(info.Address, amount, null),
            WalletAsset.Eurc => BuildSolanaPaymentUri(info.Address, amount, mint),
            WalletAsset.Xaut => BuildSolanaPaymentUri(info.Address, amount, mint),
            _ => info.Address
        };

        var payload = string.IsNullOrWhiteSpace(paymentUri) ? info.Address : paymentUri;
        qrCodeMarkup = string.IsNullOrWhiteSpace(payload) ? default : GenerateQrMarkup(payload);
    }

    private string GetFormattedAssetLabel(CryptoAsset definition)
    {
        var baseLabel = asset == WalletAsset.Xaut
            ? Loc.T("GoldWalletMenuLabel")
            : definition.MenuLabel;

        return Loc.FormatWalletLabel(baseLabel);
    }

    private void OnAmountChanged()
    {
        if (amount < 0m)
        {
            amount = 0m;
        }

        UpdatePaymentRequest();
    }

    private async Task ShareRequest()
    {
        if (string.IsNullOrWhiteSpace(paymentUri))
        {
            return;
        }

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", paymentUri);
    }

    private static string BuildBitcoinPaymentUri(string address, decimal amount) =>
        amount > 0m ? $"bitcoin:{address}?amount={amount.ToString("0.########", System.Globalization.CultureInfo.InvariantCulture)}" : $"bitcoin:{address}";

    private static string BuildSolanaPaymentUri(string address, decimal amount, string? mint)
    {
        var queryParts = new List<string>();
        if (amount > 0m)
        {
            queryParts.Add($"amount={amount.ToString("0.########", System.Globalization.CultureInfo.InvariantCulture)}");
        }

        if (!string.IsNullOrWhiteSpace(mint))
        {
            queryParts.Add($"token={Uri.EscapeDataString(mint)}");
        }

        if (queryParts.Count == 0)
        {
            return $"solana:{address}";
        }

        return $"solana:{address}?{string.Join('&', queryParts)}";
    }

    private static MarkupString GenerateQrMarkup(string payload)
    {
        using var generator = new QRCoder.QRCodeGenerator();
        using var data = generator.CreateQrCode(payload, QRCoder.QRCodeGenerator.ECCLevel.Q);
        var qrCode = new QRCoder.SvgQRCode(data);
        var svg = qrCode.GetGraphic(6);
        return new MarkupString(svg);
    }

}
